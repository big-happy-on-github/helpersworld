<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q-Learning NFL Predictor</title>
    <script>
        // Q-Learning parameters
        let learningRate = 0.2;
        let discountFactor = 0.95;
        let explorationRate = 1.0;
        let explorationDecay = 0.995;
        let minExplorationRate = 0.01;
        let stateSpace = {};  // Will store all states (games)
        let qTable = {};  // Q-table to store the state-action values
        let results = {};  // Will store win/loss results for teams

        // Function to get game data from a specific year
        async function getGameData(year) {
            let url = `https://api.sportradar.com/nfl/official/trial/v7/en/games/${year}/reg/schedule.xml?api_key=vambt4sCa5XVqVqQCdaKFDVx98n6eMMW70lop61F`;

            try {
                let response = await fetch(url);
                let text = await response.text();
                let parser = new DOMParser();
                let xml = parser.parseFromString(text, "application/xml");

                let games = xml.getElementsByTagName("game");

                for (let game of games) {
                    let home = game.getElementsByTagName("home")[0].getAttribute("name").toLowerCase().trim();
                    let away = game.getElementsByTagName("away")[0].getAttribute("name").toLowerCase().trim();
                    let state = [home, away].sort().toString();

                    let scoring = game.getElementsByTagName("scoring")[0];
                    let homeScore = scoring ? parseInt(scoring.getAttribute('home_points')) : 0;
                    let awayScore = scoring ? parseInt(scoring.getAttribute('away_points')) : 0;

                    stateSpace[state] = {
                        homeScore: homeScore,
                        awayScore: awayScore,
                        homeAdvantage: home ? 1 : 0
                    };

                    if (homeScore > awayScore) {
                        results[home] = results[home] || [];
                        results[home].push(away);
                    } else {
                        results[away] = results[away] || [];
                        results[away].push(home);
                    }

                    if (!qTable[state]) {
                        qTable[state] = [Math.random() * 0.2 - 0.1, Math.random() * 0.2 - 0.1];
                    }
                }
            } catch (error) {
                console.error(`Error fetching data for year ${year}:`, error);
            }
        }

        // Function to choose action
        function chooseAction(state) {
            if (Math.random() < explorationRate) {
                return Math.floor(Math.random() * 2);  // Random action (exploration)
            } else {
                return qTable[state].indexOf(Math.max(...qTable[state]));  // Exploit best option
            }
        }

        // Function to update Q-table
        function updateQTable(state, action, reward, nextState) {
            let bestNextAction = qTable[nextState].indexOf(Math.max(...qTable[nextState]));
            qTable[state][action] = qTable[state][action] + learningRate * (
                reward + discountFactor * qTable[nextState][bestNextAction] - qTable[state][action]
            );
        }

        // Practice phase to train the AI
        function practicePhase() {
            console.log("Practice phase has begun...");
            for (let i = 0; i < 50000; i++) {
                for (let state in stateSpace) {
                    let gameData = stateSpace[state];
                    let homeScore = gameData.homeScore;
                    let awayScore = gameData.awayScore;

                    let actualWinner = homeScore > awayScore ? 0 : 1;

                    let action = chooseAction(state);
                    let reward = action === actualWinner ? 5 : -10;

                    updateQTable(state, action, reward, state);
                }
            }
            console.log("Practice phase complete");
        }

        // Fetch data from multiple years
        async function fetchData() {
            for (let year = 2015; year <= 2025; year++) {
                console.log(`Fetching data for ${year}...`);
                await getGameData(year);
            }
            practicePhase();
        }

        // Main interaction logic
        async function mainLoop() {
            await fetchData();

            while (true) {
                let team1 = prompt("Enter Team 1:").toLowerCase().trim();
                let team2 = prompt("Enter Team 2:").toLowerCase().trim();
                let state = [team1, team2].sort().toString();

                if (!qTable[state]) {
                    qTable[state] = [Math.random() * 0.2 - 0.1, Math.random() * 0.2 - 0.1];
                }

                let action = chooseAction(state);
                let prediction = action === 0 ? team1 : team2;

                alert(`Prediction: ${prediction}`);

                let userFeedback = prompt("Was the prediction correct? (y/n):").toLowerCase().trim();
                let reward = userFeedback === 'y' ? 2 : (userFeedback === 'n' ? -5 : 0);

                updateQTable(state, action, reward, state);

                // Update exploration rate
                explorationRate = Math.max(minExplorationRate, explorationRate * explorationDecay);
                console.log(`Exploration rate: ${explorationRate}`);
            }
        }

        // Start the main loop when the page is loaded
        window.onload = mainLoop;

    </script>
</head>
<body>
    <h1>NFL Q-Learning Predictor</h1>
</body>
</html>
